# 数据库难点

------

## 1、innodb如何保证事务的特性

事务的特性：原子性、一致性、隔离性、持久性

- ### <font color=" \#EE30A7 ">redo log 重做日志用来保证事务的持久性</font>

  重做日志中存储的是事务的执行日志，

  <font color=" \#E0FFFF ">重做日志分为两个部分，一个是内存中存在的重做日志缓冲；容易丢失，另一个是重做日志文件；持久化。</font>

  innodb在以下情况下才会把缓冲的日志持久化到日志文件中（ innodb_flush_log_at_trx_commoit参数来控制重做日志刷新到磁盘的策略 ）

  1. master thread每一秒对缓冲日志进行刷新，然后将缓冲日志持久化到日志文件中；
  2. 当缓冲日志的剩余空间小于1/2的时候，自动进行持久化
  3. 每个事务提交的时候

  所以这里就存在一个面试问题，如何优化MySql

  ​		这里就需要从硬件的角度去考虑这个问题，因为日志文件的持久化就涉及到磁盘的读写性能，所以更换成SSD固态硬盘。

- ### <font color="\#EE30A7 ">undo log 回滚日志保证事务的原子性</font>

  为了保证事务的原子性，每次事务开始的时候，都会将数据备份到一个地方，这个地方就叫做undo log

  Undo Log的原理很简单，为了满足事务的原子性，在操作任何数据之前，首先将数据备份到一个地方（这个存储数据备份的地方称为Undo Log）。然后进行数据的修改。如果出现了错误或者用户执行了ROLLBACK语句，系统可以利用Undo Log中的备份将数据恢复到事务开始之前的状态。

  当事务发生错误的时候就会根据undo log自动回滚到事务开始前的状态。

  这里就存在一个面试问题，为什么事务提交之后，undo log不会立马消失

  ​		因为可能还要有其他事务通过undo log来查找之前的行记录，这里主要是可重复读的问题，

  又一个面试问题，undo log既然不会立马删除，那它去哪里了

  ​		undo log 在事务提交之后就会进入一个维护的链表

  再一个面试问题，什么时候才能删除

  ​		两种情况：

  ​			1、如果是insert undo log，insert操作的记录只对事务自身可见，对其他事务不可见，所以事务一点提交之后，insert undo log就会立马被删除；

  ​			2、如果是update undo log，记录的事删除和更新的操作，所以该undo log需要提供MVCC机制，因此不能在事务提交的时候立马就进行删除，而是放入undo链表中，等待purge线程来进行最后的删除。

- ### <font color="\#EE30A7 ">redo log 和 undo log保证事务的一致性</font>

- ### <font color="\#EE30A7">锁来保证事务的隔离性</font>

  innodb锁的类型有两种：行级锁和意向锁

  1. 行级锁  |   对一行数据进行操作的时候

     - 共享锁，允许事务读一行数据，当数据需要读取一行数据的时候必须获取共享锁，其他事务就只能获取共享锁而不能获取排他锁，这样就提高了读读的并发能力。
     - 排它锁，允许事务更新一行数据，当数据需要更新一行数据的时候必须获取排它锁，其他事务只能等待执行，

  2. 意向锁   |    对一表里面的多行数据进行操作

     - 意向共享锁，当事务对一个表里面的多行数据进行读取的时候就必须获取意向共享锁，
     - 意向排他锁，当事务对一个表里面的多行数据进行更新的时候就必须获取意向排它锁，

     意向锁的作用就在于当其他事务对已经被锁的数据进行操作的时候就会在表的级别上进行通知，这样就可以大大提高innodb对锁的定位和性能的提高。

## 2、BinLog日志使用总结

### a、定义

binlog日志用于记录所有更新了数据或者已经潜在更新了数据（未执行成功的更新数据的语句）的所有语句。语句以“事件”的形式保存，描述数据的更改。但是binlog是不会及了select和show的这一类操作的，因为这一类操作对数据本身并没有修改。

### b、误解

- **binlog知识一类记录操作内容的日志文件**

​      binlog是二进制日志，二进制日志和日常的代码日志不同，二进制日志包括两类文件：

​		***索引文件***（后缀名为.index）用于记录那些日志文件正在被使用

​		***日志文件***（文件后缀名为.00000*）记录数据库所有的DDL和DML（除了数据查询语句）语句事件。

- ​	











































